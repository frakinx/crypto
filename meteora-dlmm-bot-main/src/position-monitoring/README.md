# Модуль мониторинга и управления позициями

## Описание

Этот модуль реализует автоматический мониторинг и управление позициями в пулах Meteora DLMM с использованием стратегии Mirror Swapping для хеджирования Impermanent Loss.

## Архитектура

Модуль состоит из следующих компонентов:

### 1. `config.ts` - Конфигурация админа
- Параметры коридора (верхний и нижний процент от текущей цены)
- Параметры stop loss и take profit
- Параметры автоподбора пула
- Параметры мониторинга

### 2. `types.ts` - Типы данных
- `PositionInfo` - информация о позиции
- `PositionDecision` - решение по позиции
- `PriceUpdate` - обновление цены
- `FeeVsLossCalculation` - расчет fee vs losses

### 3. `priceMonitor.ts` - Мониторинг цены
- Отслеживание текущей цены пула
- Проверка границ позиции
- Расчет позиции цены относительно границ

### 4. `strategyCalculator.ts` - Расчет стратегии
- Расчет накопленных комиссий
- Сравнение fee с потерями от stop loss
- Расчет hedge amount для Mirror Swapping

### 5. `positionManager.ts` - Управление позициями
- Открытие новых позиций
- Закрытие позиций
- Принятие решений по позициям
- Сохранение/загрузка позиций

### 6. `poolSelector.ts` - Автоподбор пула
- Поиск подходящих пулов по критериям
- Оценка пулов по ликвидности, объему, комиссиям
- Подбор пула для новой позиции

### 7. `monitor.ts` - Главный модуль мониторинга
- Объединяет все компоненты
- Управляет циклом мониторинга
- Выполняет решения по позициям

### 8. `storage.ts` - Хранилище позиций
- Сохранение позиций в JSON файл
- Загрузка позиций при старте
- Обновление статусов позиций

## Логика работы

### 1. Мониторинг позиций

После открытия позиции запускается мониторинг:

1. **Проверка верхнего потолка (Take Profit)**
   - Если цена >= верхней границы → закрываем позицию

2. **Проверка при падении цены**
   - Если цена падает и достигает уровня проверки fee (например, 50% от нижней границы):
     - Рассчитываем накопленные комиссии
     - Рассчитываем потери при закрытии на stop loss (-2% от нижней границы)
     - Если fee >= потери → закрываем позицию по SL
     - Если fee < потери → оставляем позицию и открываем новую ниже

3. **Проверка нижней границы (Stop Loss)**
   - Если цена <= нижней границы → закрываем позицию

### 2. Автоподбор пула

На основе параметров админа:
- Коридор в процентах (верхний и нижний)
- Минимальная ликвидность
- Минимальный объем за 24ч
- Предпочтительный bin step

Система автоматически подбирает подходящий пул.

### 3. Mirror Swapping стратегия

Согласно презентации, для хеджирования IL:
- Когда LP продает актив → бот покупает в кошельке
- Когда LP покупает актив → бот продает в кошельке
- Это создает дельта-нейтральную позицию

## Использование

```typescript
import { PositionMonitor } from './position-monitoring/index.js';
import { getConnection } from './rpc.js';
import { loadKeypairFromEnv } from './utils/wallet.js';

const connection = getConnection();
const keypair = loadKeypairFromEnv(process.env.WALLET_SECRET_KEY);

const monitor = new PositionMonitor(connection, keypair);
monitor.start(); // Запустить мониторинг
```

## API Endpoints

### GET `/api/admin/config`
Получить конфигурацию админа

### POST `/api/admin/config`
Сохранить конфигурацию админа

### POST `/api/meteora/close-position`
Закрыть позицию

## Конфигурация

Админ может настроить:
- `priceCorridorPercent.upper` - процент выше текущей цены (например, 4%)
- `priceCorridorPercent.lower` - процент ниже текущей цены (например, 4%)
- `stopLossPercent` - stop loss в процентах от нижней границы (например, -2%)
- `feeCheckPercent` - процент от нижней границы для проверки fee (например, 50%)
- `takeProfitPercent` - take profit в процентах (например, ±2%)

## TODO / Что нужно доработать

1. **Получение реальных данных о комиссиях**
   - Сейчас используется упрощенная модель расчета
   - Нужно получать реальные данные из SDK или API

2. **Получение реальных данных о пуле**
   - Ликвидность, объем, комиссии нужно получать из API или SDK
   - Сейчас используются заглушки

3. **Реализация Mirror Swapping**
   - Нужно реализовать выполнение swap через Jupiter для хеджирования
   - Расчет точного количества для хеджирования

4. **Обработка множественных транзакций**
   - SDK может возвращать массив транзакций
   - Нужно обрабатывать все транзакции, а не только первую

5. **Улучшение расчета стоимости позиции**
   - Сейчас используется упрощенная модель
   - Нужно учитывать реальное распределение по bins

6. **Обработка ошибок и retry логика**
   - Добавить retry для неудачных транзакций
   - Обработка сетевых ошибок

7. **Логирование и мониторинг**
   - Добавить детальное логирование всех действий
   - Метрики производительности

8. **Тестирование**
   - Unit тесты для каждого модуля
   - Integration тесты для полного цикла

